jQuery(document).ready(function($){"use strict";var nl2br=function(string,isXhtml){var breakTag=isXhtml||typeof isXhtml==="undefined"?"<br />":"<br>";return(string+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+breakTag+"$2")};var closeCopyMessageElement=function(element){$(element).fadeTo(1e4,500).slideUp(500,function(){$(this).slideUp(500,function(){$(this).remove()})})};var showSuccess=function(message,element){$(element).html('<div class="alert alert-success alert-dismissable alert-copy-success">'+'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+message+"</div>");closeCopyMessageElement(".alert-copy-success");return};var showError=function(message,element){$(element).html('<div class="alert alert-danger alert-dismissable alert-copy-error">'+'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+message+"</div>");closeCopyMessageElement(".alert-copy-error");return};var sanitizeInput=function(input){if(input){var returnValue=input.replace(/<(|\/|[^>\/bi]|\/[^>bi]|[^\/>][^>]+|\/[^>][^>]+)>/g,"");return returnValue}else{return input}};var escapeInput=function(input,quotesToEntities){quotesToEntities=quotesToEntities||false;if(input){var returnValue=sanitizeInput(input).replace(/&/g,"&amp;");if(quotesToEntities===true){returnValue=returnValue.replace(/"/g,"&quot;")}if(quotesToEntities===false){returnValue=returnValue.replace(/"/g,'\\"')}return returnValue}else{return input}};var sendEmbeddedDiscordPing=function(webhookUrl,content,embeds){var request=new XMLHttpRequest;request.open("POST",webhookUrl);request.setRequestHeader("Content-type","application/json");var params={username:"",avatar_url:"",content:content,embeds:[embeds]};request.send(JSON.stringify(params))};var sendDiscordPing=function(webhookUrl,pingText){var request=new XMLHttpRequest;request.open("POST",webhookUrl);request.setRequestHeader("Content-type","application/json");var params={username:"",avatar_url:"",content:pingText};request.send(JSON.stringify(params))};var sendSlackPing=function(webhookUrl,payload){$.ajax({data:"payload="+JSON.stringify(payload),dataType:"json",processData:false,type:"POST",url:webhookUrl})};var hexToDecimal=function(hexValue){return parseInt(hexValue.replace("#",""),16)};var getTimezonesUrl=function(formupTime){var formupDateTime=new Date(formupTime);var formupTimestamp=(formupDateTime.getTime()-formupDateTime.getTimezoneOffset()*60*1e3)/1e3;var timezonesUrl="";if(fleetpingsSettings.useNewTimezoneLinks===true){timezonesUrl=fleetpingsSettings.siteUrl+"timezones/"+formupTimestamp+"/"}else{timezonesUrl=fleetpingsSettings.siteUrl+"timezones/?#"+formupTimestamp}return timezonesUrl};var generateFleetPing=function(fleetSrpCode){var pingTarget=sanitizeInput($("select#pingTarget option:selected").val());var pingTargetText=sanitizeInput($("select#pingTarget option:selected").text());var webhookType=sanitizeInput($("select#pingChannel option:selected").data("webhook-type"));var webhookEmbedPing=sanitizeInput($("select#pingChannel option:selected").data("webhook-embed"));var fleetType=sanitizeInput($("select#fleetType option:selected").val());var webhookEmbedColor=sanitizeInput($("select#fleetType option:selected").data("embed-color"));var fcName=sanitizeInput($("input#fcName").val());var fleetName=sanitizeInput($("input#fleetName").val());var formupLocation=sanitizeInput($("input#formupLocation").val());var formupTime=sanitizeInput($("input#formupTime").val());var fleetComms=sanitizeInput($("input#fleetComms").val());var fleetDoctrine=sanitizeInput($("input#fleetDoctrine").val());var fleetSrp=sanitizeInput($("select#fleetSrp option:selected").val());var additionalInformation=sanitizeInput($("textarea#additionalInformation").val());var fleetDoctrineLink=null;if(fleetDoctrine!==""){var selectedLink=$('#fleetDoctrineList [value="'+escapeInput(fleetDoctrine,false)+'"]').data("doctrine-url");if(undefined!==selectedLink&&selectedLink!==""){fleetDoctrineLink=selectedLink}}var webhookUrl=false;if($("select#pingChannel").length){webhookUrl=sanitizeInput($("select#pingChannel option:selected").val())}$(".aa-fleetpings-no-ping").hide("fast");$(".aa-fleetpings-ping").show("fast");var webhookPingTextHeader="";var webhookPingTextContent="";var webhookPingTextFooter="";var pingText="";var discordPingTarget="";var webhookPingTarget="";if(pingTarget!==""){if(pingTarget.indexOf("@")>-1){webhookPingTarget=pingTarget}else{webhookPingTarget="<@&"+pingTarget+">"}if(pingTargetText.indexOf("@")>-1){discordPingTarget=pingTargetText}else{discordPingTarget="@"+pingTargetText}pingText+=" :: "}pingText+="**";if($("input#prePing").is(":checked")){pingText+="### PRE PING ###";webhookPingTextHeader+="### PRE PING ###";if(fleetType!==""){pingText+=" / "+fleetType+" Fleet";webhookPingTextHeader+=" / "+fleetType+" Fleet"}}else{if(fleetType!==""){pingText+=fleetType+" ";webhookPingTextHeader+=fleetType+" "}pingText+="Fleet is up";webhookPingTextHeader+="Fleet is up"}pingText+="**"+"\n";if(fcName!==""){pingText+="\n"+"**FC:** "+fcName;webhookPingTextContent+="\n"+"**FC:** "+fcName}if(fleetName!==""){pingText+="\n"+"**Fleet Name:** "+fleetName;webhookPingTextContent+="\n"+"**Fleet Name:** "+fleetName}if(formupLocation!==""){pingText+="\n"+"**Formup Location:** "+formupLocation;webhookPingTextContent+="\n"+"**Formup Location:** "+formupLocation}if($("input#formupTimeNow").is(":checked")){pingText+="\n"+"**Formup Time:** NOW";webhookPingTextContent+="\n"+"**Formup Time:** NOW"}else{if(formupTime!==""){pingText+="\n"+"**Formup Time:** "+formupTime;webhookPingTextContent+="\n"+"**Formup Time:** "+formupTime;if(fleetpingsSettings.timezonesInstalled===true){var timezonesUrl=getTimezonesUrl(formupTime);pingText+=" - "+timezonesUrl;if(webhookType==="Discord"){webhookPingTextContent+=" ([Time Zone Conversion]("+timezonesUrl+"))"}if(webhookType==="Slack"){webhookPingTextContent+=" (<"+timezonesUrl+"|Time Zone Conversion>)"}}}}if(fleetComms!==""){pingText+="\n"+"**Comms:** "+fleetComms;webhookPingTextContent+="\n"+"**Comms:** "+fleetComms}if(fleetDoctrine!==""){pingText+="\n"+"**Ships / Doctrine:** "+fleetDoctrine;webhookPingTextContent+="\n"+"**Ships / Doctrine:** "+fleetDoctrine;if(fleetDoctrineLink!==null){pingText+=" - "+fleetDoctrineLink;if(webhookType==="Discord"){webhookPingTextContent+=" ([Doctrine Link]("+fleetDoctrineLink+"))"}if(webhookType==="Slack"){webhookPingTextContent+=" (<"+fleetDoctrineLink+"|Doctrine Link>)"}}}if(fleetSrp!==""){pingText+="\n"+"**SRP:** "+fleetSrp;webhookPingTextContent+="\n"+"**SRP:** "+fleetSrp;if(fleetSrp==="Yes"&&fleetSrpCode!==""){pingText+=" (SRP Code: "+fleetSrpCode+")";webhookPingTextContent+=" (SRP Code: "+fleetSrpCode+")"}}if(additionalInformation!==""){pingText+="\n\n"+"**Additional Information**:"+"\n"+additionalInformation;webhookPingTextContent+="\n\n"+"**Additional Information**:"+"\n"+additionalInformation}if(fleetpingsSettings.platformUsed==="Discord"){$(".aa-fleetpings-ping-text").html("<p>"+nl2br(discordPingTarget+pingText)+"</p>")}if(fleetpingsSettings.platformUsed==="Slack"){$(".aa-fleetpings-ping-text").html("<p>"+nl2br(discordPingTarget+pingText.split("**").join("*"))+"</p>")}if(webhookUrl!==false&&webhookUrl!==""){if(fleetpingsSettings.pingCreator!==""){pingText+="\n\n"+"*(Ping sent by: "+fleetpingsSettings.pingCreator+")*";webhookPingTextFooter="(Ping sent by: "+fleetpingsSettings.pingCreator+")"}var embedColor="#faa61a";if(fleetType!==""&&embedColor!==""){embedColor=webhookEmbedColor}if(fcName!==""){webhookPingTextHeader+=" under "+fcName}var copyPasteText="";if(webhookType==="Discord"){if(undefined!==webhookEmbedPing&&webhookEmbedPing==="True"){if(pingTarget!==""){webhookPingTarget+=" :: "}sendEmbeddedDiscordPing(webhookUrl,webhookPingTarget+"**"+webhookPingTextHeader+"**"+"\n"+"** **",{title:"**.: Fleet Details :.**",description:webhookPingTextContent,color:hexToDecimal(embedColor),footer:{text:webhookPingTextFooter}})}else{sendDiscordPing(webhookUrl,webhookPingTarget+pingText)}}if(webhookType==="Slack"){var slackEmbedPingTarget="";if(pingTarget!==""){slackEmbedPingTarget="<"+webhookPingTarget.replace("@","!")+"> :: "}var payload={attachments:[{fallback:pingText,color:embedColor,pretext:slackEmbedPingTarget+"*"+webhookPingTextHeader+"*",text:"*.: Fleet Details :.*"+"\n"+webhookPingTextContent.split("**").join("*"),footer:webhookPingTextFooter}]};sendSlackPing(webhookUrl,payload)}showSuccess(fleetpingsTranslations.ping.success,".aa-fleetpings-ping-copyresult")}if(fleetpingsSettings.optimerInstalled===true){if($("input#prePing").is(":checked")&&$("input#createOptimer").is(":checked")&&formupTime!==""){var optimerAjaxUrl=fleetpingsSettings.optimerAjaxUrl;$.ajax({url:optimerAjaxUrl,type:"post",data:{fleet_doctrine:fleetDoctrine,formup_location:formupLocation,formup_time:formupTime,fleet_name:fleetName,fleet_commander:fcName},headers:{"X-CSRFToken":$('input[name="csrfmiddlewaretoken"]').val()}});$("input#createOptimer").removeAttr("checked");showSuccess(fleetpingsTranslations.optimer.created,".fleetpings-create-optimer-message")}}};var copyFleetPing=function(){var clipboardFleetPingData=new ClipboardJS("button#copyFleetPing");clipboardFleetPingData.on("success",function(e){showSuccess(fleetpingsTranslations.copyToClipboard.success,".aa-fleetpings-ping-copyresult");e.clearSelection();clipboardFleetPingData.destroy()});clipboardFleetPingData.on("error",function(){showError(fleetpingsTranslations.copyToClipboard.error,".aa-fleetpings-ping-copyresult");clipboardFleetPingData.destroy()})};if(fleetpingsSettings.srpModuleAvailableToUser===true){if(sanitizeInput($("select#fleetSrp option:selected").val())==="Yes"&&$("input#formupTimeNow").is(":checked")){$(".fleetpings-create-srp-link").show("fast")}else{$("input#createSrpLink").removeAttr("checked");$(".fleetpings-create-srp-link").hide("fast")}$("select#fleetSrp").change(function(){if(sanitizeInput($("select#fleetSrp option:selected").val())==="Yes"&&$("input#formupTimeNow").is(":checked")){$(".fleetpings-create-srp-link").show("fast")}else{$("input#createSrpLink").removeAttr("checked");$(".fleetpings-create-srp-link").hide("fast")}})}$("#prePing").on("change",function(){if($("input#prePing").is(":checked")){$("input#formupTimeNow").removeAttr("checked");$("input#formupTime").removeAttr("disabled");if(fleetpingsSettings.optimerInstalled===true){$(".fleetpings-create-optimer").show("fast")}if(fleetpingsSettings.srpModuleAvailableToUser===true){$("input#createSrpLink").removeAttr("checked");$(".fleetpings-create-srp-link").hide("fast")}}else{$("input#formupTimeNow").prop("checked",true).removeAttr("disabled");$("input#formupTime").prop("disabled",true);if(fleetpingsSettings.optimerInstalled===true){$("input#createOptimer").removeAttr("checked");$(".fleetpings-create-optimer").hide("fast")}if(fleetpingsSettings.srpModuleAvailableToUser===true&&sanitizeInput($("select#fleetSrp option:selected").val())==="Yes"){$(".fleetpings-create-srp-link").show("fast")}}});$("input#formupTimeNow").on("change",function(){if($(this).is(":checked")){$("input#prePing").removeAttr("checked");$("input#formupTime").prop("disabled",true);if(fleetpingsSettings.optimerInstalled===true){$("input#createOptimer").removeAttr("checked");$(".fleetpings-create-optimer").hide("fast")}if(fleetpingsSettings.srpModuleAvailableToUser===true&&sanitizeInput($("select#fleetSrp option:selected").val())==="Yes"){$(".fleetpings-create-srp-link").show("fast")}}else{$("input#prePing").prop("checked",true).removeAttr("disabled");$("input#formupTime").removeAttr("disabled");if(fleetpingsSettings.optimerInstalled===true){$(".fleetpings-create-optimer").show("fast")}if(fleetpingsSettings.srpModuleAvailableToUser===true){$("input#createSrpLink").removeAttr("checked");$(".fleetpings-create-srp-link").hide("fast")}}});$("button#createPingText").on("click",function(){var fleetSrp=sanitizeInput($("select#fleetSrp option:selected").val());var fleetName=sanitizeInput($("input#fleetName").val());var fleetDoctrine=sanitizeInput($("input#fleetDoctrine").val());if($("input#createSrpLink").is(":checked")&&$("input#formupTimeNow").is(":checked")){var srpAjaxUrl=fleetpingsSettings.srpAjaxUrl;var srpCode="";$.ajax({url:srpAjaxUrl,type:"post",data:{fleet_doctrine:fleetDoctrine,fleet_name:fleetName},headers:{"X-CSRFToken":sanitizeInput($('input[name="csrfmiddlewaretoken"]').val())}}).done(function(result){srpCode=result.srp_code;generateFleetPing(srpCode);showSuccess(fleetpingsTranslations.srp.created,".fleetpings-create-srp-link-message")});$("input#createSrpLink").removeAttr("checked")}else{generateFleetPing("")}return false});$("button#copyFleetPing").on("click",function(){copyFleetPing()})});