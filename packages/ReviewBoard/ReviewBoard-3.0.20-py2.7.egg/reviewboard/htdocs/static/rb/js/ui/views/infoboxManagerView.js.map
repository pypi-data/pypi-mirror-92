{"version":3,"sources":["infoboxManagerView.es6.js"],"names":[],"mappings":"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","file":"infoboxManagerView.js","sourcesContent":["/**\n * Manages the registration, display, and interaction of infoboxes.\n *\n * This view is responsible for tracking the various forms of infoboxes needed\n * on a page and handling their display when hovering over a target. It can\n * also create jQuery functions for registering elements with particular\n * infoboxes.\n *\n * There's only one instance used per page, accessed via\n * :js:func:`RB.InfoboxManagerView.getInstance`.\n */\nRB.InfoboxManagerView = Backbone.View.extend({\n    /** The delay after hovering over a target before displaying an infobox. */\n    POPUP_DELAY_MS: 700,\n\n    /** The delay after leaving a target before hiding an infobox. */\n    HIDE_DELAY_MS: 400,\n\n    /** The animation time for fading in an infobox. */\n    FADE_IN_MS: 200,\n\n    /** The animation time for fading out an infobox. */\n    FADE_OUT_MS: 150,\n\n    /**\n     * Initialize the manager.\n     */\n    initialize() {\n        this._infoboxViews = {};\n        this._activeInfoboxView = null;\n        this._cache = {};\n        this._showTimeout = null;\n        this._hideTimeout = null;\n    },\n\n    /**\n     * Remove the manager's infoboxes from the DOM.\n     */\n    remove() {\n        Backbone.View.prototype.remove.call(this);\n\n        for (let key in this._infoboxViews) {\n            if (this._infoboxViews.hasOwnProperty(key)) {\n                this._infoboxViews[key].remove();\n            }\n        }\n\n        this._infoboxViews = {};\n        this._cache = {};\n        this._activeInfoboxView = null;\n    },\n\n    /**\n     * Add one or more targets for a particular type of infobox.\n     *\n     * These targets will trigger the specified infobox when hovering over\n     * them.\n     *\n     * Args:\n     *     infoboxViewType (prototype):\n     *         The type of infobox to register with. This must be a subclass\n     *         of :js:class:`RB.BaseInfoboxView`.\n     *\n     *     $targets (jQuery):\n     *         A set of jQuery targets to register with the infobox.\n     */\n    addTargets(infoboxViewType, $targets) {\n        $targets.each((idx, target) => {\n            const $target = $(target);\n\n            if (!$target.data('has-infobox')) {\n                /*\n                 * Note that we're wanting to bind the functions instead of\n                 * using fat arrow functions in order to avoid having two\n                 * new anonymous functions per target, which is wasteful and\n                 * unnecessary.\n                 */\n                $target\n                    .data('has-infobox', true)\n                    .on('mouseenter',\n                        this._onTargetMouseEnter.bind(this, $target,\n                                                      infoboxViewType))\n                    .on('mouseleave', this._onMouseLeave.bind(this));\n            }\n        });\n    },\n\n    /**\n     * Set the positioning for a particular type of infobox.\n     *\n     * This is used to control how an infobox would be positioned on the\n     * page, relative to the target element. It completely overrides the\n     * default positioning for that type of infobox.\n     *\n     * Args:\n     *     infoboxViewType (prototype):\n     *         The type of infobox to alter the position for.\n     *\n     *     positioning (object):\n     *         The positioning information. This must be a value compatible\n     *         with :js:func:`$.fn.positionToSide`.\n     */\n    setPositioning(infoboxViewType, positioning) {\n        this.getOrCreateInfobox(infoboxViewType).positioning = positioning;\n    },\n\n    /**\n     * Return an instance of a particular type of infobox.\n     *\n     * If the instance doesn't yet exist, it will be created and registered\n     * with the manager.\n     *\n     * Args:\n     *     InfoboxViewType (prototype):\n     *         The type of infobox to return.\n     *\n     * Returns:\n     *     RB.BaseInfoboxView:\n     *     The resulting infobox instance.\n     */\n    getOrCreateInfobox(InfoboxViewType) {\n        const infoboxID = InfoboxViewType.prototype.infoboxID;\n        console.assert(infoboxID,\n                       'RB.BaseInfoboxView subclasses must have an ' +\n                       'infoboxID defined.');\n\n        let view = this._infoboxViews[infoboxID];\n\n        if (view) {\n            return view;\n        }\n\n        view = new InfoboxViewType();\n        view.$el\n            .hide()\n            .on('mouseenter', this._onInfoboxMouseEnter.bind(this))\n            .on('mouseleave', this._onMouseLeave.bind(this))\n            .appendTo(document.body);\n\n        this._infoboxViews[infoboxID] = view;\n\n        return view;\n    },\n\n    /**\n     * Load the contents for an infobox and display it.\n     *\n     * This will perform a HTTP GET on the infobox URL for the given target\n     * and then show the infobox with those contents. If the URL has already\n     * been fetched, the infobox will be displayed immediately and then the\n     * contents replaced once fetched.\n     *\n     * Args:\n     *     $target (jQuery):\n     *         The jQuery target element the infobox is being shown for.\n     *\n     *     infoboxView (RB.BaseInfoboxView):\n     *         The infobox view that will contain the HTML contents.\n     */\n    _loadInfobox($target, infoboxView) {\n        console.assert(\n            $target.length === 1,\n            'Too many targets matched when fetching infobox contents');\n\n        const url = infoboxView.getURLForTarget($target);\n        const cachedData = this._cache[url];\n\n        if (cachedData !== undefined) {\n            /*\n             * If we have cached data, show that immediately and update once we\n             * have the result from the server.\n             */\n            infoboxView.setContents(cachedData);\n            this._showInfobox(infoboxView, $target);\n        }\n\n        this._fetchInfoboxContents(url, html => {\n            this._cache[url] = html;\n            infoboxView.setContents(html);\n\n            if (cachedData === undefined) {\n                this._showInfobox(infoboxView, $target);\n            }\n        });\n    },\n\n    /**\n     * Fetch the contents for an infobox from the given URL.\n     *\n     * Args:\n     *     url (string):\n     *         The URL containing the infobox HTML.\n     *\n     *     onDone (function):\n     *         The handler to call when the infobox HTML has been fetched.\n     */\n    _fetchInfoboxContents(url, onDone) {\n        $.ajax(url, {\n            ifModified: true,\n        }).done(onDone);\n    },\n\n    /**\n     * Display an infobox alongside the given target.\n     *\n     * Args:\n     *     infoboxView (RB.BaseInfoboxView):\n     *         The infobox instance to use.\n     *\n     *     $target (jQuery):\n     *         The jQuery element to position the infobox beside.\n     */\n    _showInfobox(infoboxView, $target) {\n        infoboxView.$el\n            .positionToSide($target, _.defaults(infoboxView.positioning, {\n                fitOnScreen: true,\n            }))\n            .fadeIn(this.FADE_IN_MS);\n\n        this._activeInfoboxView = infoboxView;\n    },\n\n    /**\n     * Hide the active infobox.\n     */\n    _hideInfobox() {\n        if (this._activeInfoboxView) {\n            const curInfoboxView = this._activeInfoboxView;\n\n            this._activeInfoboxView.$el.fadeOut(\n                this.FADE_OUT_MS,\n                () => {\n                    /*\n                     * Only clear the active infobox if it hasn't been\n                     * replaced with a new one.\n                     */\n                    if (curInfoboxView === this._activeInfoboxView) {\n                        this._activeInfoboxView = null;\n                    }\n                });\n        }\n    },\n\n    /**\n     * Handler for when the mouse enters the infobox.\n     *\n     * This will prevent the infobox from being hidden after having left the\n     * target.\n     */\n    _onInfoboxMouseEnter() {\n        clearTimeout(this._hideTimeout);\n        this._hideTimeout = null;\n    },\n\n    /**\n     * Handler for when the mouse enters a target.\n     *\n     * This will wait a small amount of time (in case the user is simply\n     * temporarily mousing over the element) and then show the infobox.\n     *\n     * Args:\n     *     $target (jQuery):\n     *         The jQuery target element.\n     *\n     *     InfoboxViewType (prototype):\n     *         The type of infobox to show.\n     */\n    _onTargetMouseEnter($target, InfoboxViewType) {\n        clearTimeout(this._hideTimeout);\n        this._hideTimeout = null;\n\n        this._showTimeout = setTimeout(\n            () => {\n                this._showTimeout = null;\n                this._loadInfobox(\n                    $target,\n                    this.getOrCreateInfobox(InfoboxViewType));\n            },\n            this.POPUP_DELAY_MS);\n    },\n\n    /**\n     * Handler for when the mouse leaves a target or infobox.\n     *\n     * If an existing infobox is currently on-screen, it will be faded\n     * out after a brief delay (allowing time to move the mouse onto the\n     * infobox or back onto the target).\n     */\n    _onMouseLeave() {\n        // If we were going to show an infobox, cancel that.\n        clearTimeout(this._showTimeout);\n        this._showTimeout = null;\n\n        // Check if we need to hide any current infobox.\n        if (this._activeInfoboxView) {\n            /*\n             * We have an infobox on the screen, and the mouse is\n             * leaving it. Since there's no other infobox queued up,\n             * begin the process of fading it out, after a delay.\n             */\n            clearTimeout(this._hideTimeout);\n\n            this._hideTimeout = setTimeout(\n                () => {\n                    this._hideInfobox();\n                    this._hideTimeout = null;\n                },\n                this.HIDE_DELAY_MS);\n        }\n    },\n}, {\n    _instance: null,\n\n    /**\n     * Return an instance of the infobox manager.\n     *\n     * If one does not already exist, it will be created.\n     *\n     * Callers should always use this instead of creating an instance\n     * manually.\n     *\n     * Returns:\n     *     RB.InfoboxManagerView:\n     *     The infobox manager instance.\n     */\n    getInstance() {\n        let instance = RB.InfoboxManagerView._instance;\n\n        if (!instance) {\n            instance = new RB.InfoboxManagerView();\n            this._instance = instance;\n        }\n\n        return instance;\n    },\n\n    /**\n     * Create a jQuery function for registering elements with an infobox.\n     *\n     * This is used to create ``$.fn.`` functions that will register all\n     * matching elements as targets for a particular type of infobox.\n     *\n     * Args:\n     *     infoboxViewType (prototype):\n     *         The type of infobox to use for these elements.\n     *\n     * Returns:\n     *     function:\n     *     The resulting function. This should be assigned to a ``$.fn.``\n     *     function.\n     */\n    createJQueryFn(infoboxViewType) {\n        return function() {\n            RB.InfoboxManagerView.getInstance().addTargets(infoboxViewType,\n                                                           this);\n\n            return this;\n        };\n    },\n});\n"]}