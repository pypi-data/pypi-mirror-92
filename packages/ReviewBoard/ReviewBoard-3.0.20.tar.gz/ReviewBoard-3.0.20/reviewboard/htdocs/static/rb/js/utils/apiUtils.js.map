{"version":3,"sources":["apiUtils.es6.js"],"names":[],"mappings":"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","file":"apiUtils.js","sourcesContent":["/**\n * jQuery AJAX transport for receiving Blob and ArrayBuffer data.\n *\n * XMLHttpRequest2 supports receiving binary data represented by\n * :js:class:`Blob` and :js:class:`ArrayBuffer`. This transport enabled binary\n * data support through standard :js:func:`jQuery.ajax` calls.\n */\n$.ajaxTransport('arraybuffer blob', function(options, origOptions, jqXHR) {\n    if (!window.FormData) {\n        return null;\n    }\n\n    let xhr;\n\n    return {\n        send(headers, completeCB) {\n            xhr = options.xhr();\n            xhr.addEventListener('load', () => {\n                const result = {};\n                result[options.dataType] = xhr.response;\n\n                completeCB(xhr.status, xhr.statusText, result,\n                           xhr.getAllResponseHeaders());\n            });\n\n            if (options.username) {\n                xhr.open(options.type, options.url, options.async,\n                         options.username, options.password);\n            } else {\n                xhr.open(options.type, options.url, options.async);\n            }\n\n            xhr.responseType = options.dataType;\n\n            /* Apply any custom fields that may be provided. */\n            const xhrFields = options.xhrFields;\n\n            if (xhrFields) {\n                for (let field in xhrFields) {\n                    if (xhrFields.hasOwnProperty(field)) {\n                        xhr[field] = xhrFields[field];\n                    }\n                }\n            }\n\n            if (!options.crossDomain && !headers['X-Requested-With']) {\n                headers['X-Requested-With'] = 'XMLHttpRequest';\n            }\n\n            /*\n             * Catch errors with cross-domain requests, like jQuery does.\n             */\n            try {\n                for (let key in headers) {\n                    if (headers.hasOwnProperty(key)) {\n                        xhr.setRequestHeader(key, headers[key]);\n                    }\n                }\n            } catch (e) {}\n\n            xhr.send(options.hasContent ? options.data : null);\n        },\n\n        abort() {\n            if (xhr && xhr.readyState !== 4) {\n                xhr.abort();\n            }\n        },\n    };\n});\n\n\n/**\n * Enable or disable the activity indicator.\n *\n * Args:\n *     enabled (boolean):\n *         Whether the activity indicator should be enabled.\n *\n *     options (object):\n *         Additional options.\n *\n * Option Args:\n *     noActivityIndicator (boolean):\n *         True if the indicator should be suppressed, even if ``enabled`` is\n *         true.\n *\n *     type (string):\n *         The type of HTTP request that the indicator is representing. This\n *         will be either ``GET`` (loading) or ``POST`` (saving).\n */\nRB.setActivityIndicator = function(enabled, options) {\n    const $activityIndicator = $('#activity-indicator');\n\n    if (enabled) {\n        if (RB.ajaxOptions.enableIndicator && !options.noActivityIndicator) {\n            $activityIndicator.children('.indicator-text')\n                .text((options.type && options.type === 'GET')\n                      ? gettext('Loading...') : gettext('Saving...'));\n\n            $activityIndicator\n                .removeClass('error')\n                .show();\n        }\n    } else if (RB.ajaxOptions.enableIndicator &&\n               !options.noActivityIndicator &&\n               !$activityIndicator.hasClass('error')) {\n        $activityIndicator\n            .delay(250)\n            .fadeOut('fast');\n    }\n};\n\n\n/**\n * Make an API request.\n *\n * This will handle any button disabling/enabling, write to the correct path\n * prefix, do form uploading, and display server errors.\n *\n * Args:\n *     options (object):\n *         Options for the API request.\n *\n * Option Args:\n *     buttons (jQuery):\n *         Any buttons to disable while the API request is in flight.\n *\n *     form (jQuery):\n *         A form to submit, if any.\n *\n *     type (string):\n *         The type of HTTP request to make. Defaults to ``POST``.\n *\n *     prefix (string):\n *         The prefix for the API path (after ``SITE_ROOT``, before ``api``).\n *\n *     path (string):\n *         The relative path from the server name to the Review Board API\n *         endpoint.\n *\n *     data (object):\n *         Additional data to send with the request.\n *\n *     success (function):\n *         An optional success callback. If not specified, the default handler\n *         will reload the page.\n *\n *     error (function):\n *         An optional error callback, to be called after the error banner is\n *         displayed.\n *\n *     complete (function):\n *         An optional complete callback, which is called after the success or\n *         error callbacks.\n */\nRB.apiCall = function(options) {\n    const prefix = options.prefix || '';\n    const url = options.url || (SITE_ROOT + prefix + 'api' + options.path);\n\n    function showErrorPage(xhr, data) {\n        const $iframe = $('<iframe/>').width('100%');\n        const requestData = options.data ? $.param(options.data) : '(none)';\n\n        $('<div class=\"server-error-box\"/>')\n            .appendTo(document.body)\n            .append('<p><b>' + gettext('Error Code:') + '</b> ' + xhr.status + '</p>')\n            .append('<p><b>' + gettext('Error Text:') + '</b> ' + xhr.statusText + '</p>')\n            .append('<p><b>' + gettext('Request URL:') + '</b> ' + url + '</p>')\n            .append('<p><b>' + gettext('Request Data:') + '</b> ' + requestData + '</p>')\n            .append('<p class=\"response-data\"><b>' + gettext('Response Data:') + '</b></p>')\n            .append(gettext('<p>There may be useful error details below. The following error page may be useful to your system administrator or when <a href=\"https://www.reviewboard.org/bugs/new/\">reporting a bug</a>. To save the page, right-click the error below and choose \"Save Page As,\" if available, or \"View Source\" and save the result as a <tt>.html</tt> file.</p>'))\n            .append(gettext('<p><b>Warning:</b> Be sure to remove any sensitive material that may exist in the error page before reporting a bug!</p>'))\n            .append($iframe)\n            .on('resize', function() {\n                $iframe.height($(this).height() - $iframe.position().top);\n            })\n            .modalBox({\n                stretchX: true,\n                stretchY: true,\n                title: gettext('Server Error Details')\n            });\n\n        const doc = $iframe[0].contentDocument || $iframe[0].contentWindow.document;\n        doc.open();\n        doc.write(data);\n        doc.close();\n    }\n\n    function doCall() {\n        const $activityIndicator = $('#activity-indicator');\n\n        if (options.buttons) {\n            options.buttons.attr('disabled', true);\n        }\n\n        RB.setActivityIndicator(true, options);\n\n        const data = $.extend(true, {\n            url: url,\n            data: options.data,\n            dataType: options.dataType || 'json',\n            error: function(xhr, textStatus, errorThrown) {\n                const responseText = xhr.responseText;\n\n                let rsp = null;\n                try {\n                    rsp = JSON.parse(responseText);\n                } catch (e) {\n                }\n\n                if ((rsp && rsp.stat) || xhr.status === 204) {\n                    if (_.isFunction(options.success)) {\n                        options.success(rsp, xhr.status);\n                    }\n\n                    return;\n                }\n\n                $activityIndicator\n                    .addClass('error')\n                    .text(gettext('A server error occurred.'))\n                    .append(\n                        $('<a href=\"#\" />')\n                            .text(gettext('Show Details'))\n                            .click(() => showErrorPage(xhr, responseText))\n                    )\n                    .append(\n                        $('<a href=\"#\" />')\n                            .text(gettext('Dismiss'))\n                            .click(function() {\n                                $activityIndicator.fadeOut('fast');\n                                return false;\n                            })\n                    );\n\n                if (_.isFunction(options.error)) {\n                    options.error(xhr, textStatus, errorThrown);\n                }\n            },\n            complete: function(xhr, status) {\n                if (options.buttons) {\n                    options.buttons.attr('disabled', false);\n                }\n\n                RB.setActivityIndicator(false, options);\n\n                if (_.isFunction(options.complete)) {\n                    options.complete(xhr, status);\n                }\n\n                $.funcQueue('rbapicall').next();\n            }\n        }, options);\n\n        if (data.data === null || data.data === undefined ||\n            (data.data instanceof Object &&\n             !(window.Blob && data.data instanceof Blob))) {\n            data.data = $.extend({\n                api_format: 'json'\n            }, data.data || {});\n        }\n\n        if (options.form) {\n            options.form.ajaxSubmit(data);\n        } else {\n            $.ajax(data);\n        }\n    }\n\n    options.type = options.type || 'POST';\n\n    // We allow disabling the function queue for the sake of unit tests.\n    if (RB.ajaxOptions.enableQueuing && options.type !== 'GET') {\n        $.funcQueue('rbapicall').add(doCall);\n        $.funcQueue('rbapicall').start();\n    } else {\n        doCall();\n    }\n};\n\n/**\n * Parse API error information from a response and stores it.\n *\n * The xhr object provided will be extended with two new attributes:\n * 'errorText' and 'errorPayload'. These represent the response's error\n * message and full error payload, respectively.\n *\n * Args:\n *     xhr (jqXHR):\n *         The XMLHttpRequest object.\n */\nRB.storeAPIError = function(xhr) {\n    try {\n        const rsp = JSON.parse(xhr.responseText);\n        xhr.errorPayload = rsp;\n        xhr.errorText = rsp.err.msg;\n    } catch (e) {\n        xhr.errorPayload = null;\n        xhr.errorText = 'HTTP ' + xhr.status + ' ' + xhr.statusText;\n    }\n};\n\n\nRB.ajaxOptions = {\n    enableQueuing: true,\n    enableIndicator: true\n};\n\n\n/*\n * Call RB.apiCall instead of $.ajax.\n *\n * We wrap instead of assign for now so that we can hook in/override\n * RB.apiCall with unit tests.\n */\nBackbone.ajax = options => RB.apiCall(options);\n\n\n// vim: set et:sw=4:\n"]}