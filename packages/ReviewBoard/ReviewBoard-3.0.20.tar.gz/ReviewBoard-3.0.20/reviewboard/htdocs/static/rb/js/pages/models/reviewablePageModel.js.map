{"version":3,"sources":["reviewablePageModel.es6.js"],"names":[],"mappings":"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","file":"reviewablePageModel.js","sourcesContent":["/**\n * A page used for editing, viewing, or reviewing review requests.\n *\n * This is responsible for setting up objects needed for manipulating a\n * review request or related state, for performing reviews, or otherwise\n * handling review-related tasks.\n *\n * This can be used directly or can be subclassed in order to provide\n * additional logic.\n *\n * Attributes:\n *     commentIssueManager (RB.CommentIssueManager):\n *         Manages the issue states for published comments.\n *\n *     reviewRequestEditor (RB.ReviewRequestEditor):\n *         Manages the edit states and capabilities for the review request\n *         for the page.\n *\n * Model Attributes:\n *     checkForUpdates (boolean):\n *         Whether the page should periodically check the server for updates\n *         made to the page.\n *\n *     checkUpdatesType (string):\n *         A type identifier used to represent the page for any update checks.\n *         This corresponds to strings used server-side. Arbitrary values\n *         have undefined behavior.\n *\n *     lastActivityTimestamp (string):\n *         A string-encoded timestamp representing the last time there was\n *         known activity on the review request.\n *\n *     pendingReview (RB.Review):\n *         The pending review (which may or may not yet have a server-side\n *         representation) used for any new review content.\n *\n *     reviewRequest (RB.ReviewRequest):\n *         The review request that this page is for.\n */\nRB.ReviewablePage = RB.Page.extend({\n    defaults: _.defaults({\n        checkForUpdates: false,\n        checkUpdatesType: null,\n        lastActivityTimestamp: null,\n        pendingReview: null,\n        reviewRequest: null,\n    }, RB.Page.prototype.defaults),\n\n    /**\n     * Initialize the page.\n     *\n     * This will construct a series of objects needed to work with reviews\n     * and the review request. It will also begin checking for updates made\n     * to the page, notifying the user if anything has changed.\n     *\n     * Args:\n     *     attributes (object):\n     *         Initial attributes passed to the constructor. This is used to\n     *         access initial state that won't otherwise be stored in this\n     *         page.\n     */\n    initialize(attributes) {\n        RB.Page.prototype.initialize.apply(this, arguments);\n\n        const reviewRequest = this.get('reviewRequest');\n\n        console.assert(\n            reviewRequest,\n            'The reviewRequest attribute or parse=true must be provided.');\n        console.assert(\n            this.get('pendingReview'),\n            'The pendingReview attribute or parse=true must be provided.');\n\n        this.commentIssueManager = new RB.CommentIssueManager({\n            reviewRequest: reviewRequest,\n        });\n\n        const editorData = attributes.editorData || {};\n        const fileAttachments = new Backbone.Collection(\n            _.map(editorData.fileAttachments,\n                  (editorData.mutableByUser\n                   ? attrs => reviewRequest.draft.createFileAttachment(attrs)\n                   : attrs => reviewRequest.createFileAttachment(attrs))),\n            {\n                model: RB.FileAttachment,\n            });\n\n        this.reviewRequestEditor = new RB.ReviewRequestEditor(\n            _.defaults({\n                commentIssueManager: this.commentIssueManager,\n                reviewRequest: reviewRequest,\n                fileAttachments: fileAttachments,\n            }, editorData));\n\n        this.listenTo(reviewRequest, 'updated',\n                      info => this.trigger('reviewRequestUpdated', info));\n\n        if (this.get('checkForUpdates')) {\n            this._registerForUpdates();\n        }\n    },\n\n    /**\n     * Post a review marked as Ship It.\n     *\n     * This will create and publish a review, setting the Ship It state and\n     * changing the text to say \"Ship It!\".\n     */\n    markShipIt() {\n        const pendingReview = this.get('pendingReview');\n\n        pendingReview.ready({\n            ready() {\n                pendingReview.set({\n                    shipIt: true,\n                    bodyTop: gettext('Ship It!'),\n                });\n                pendingReview.publish();\n            },\n        });\n    },\n\n    /**\n     * Parse the data for the page.\n     *\n     * This will take data from the server and turn it into a series of\n     * objects and attributes needed for parts of the page.\n     *\n     * Args:\n     *     rsp (object):\n     *         The incoming data provided for the page.\n     *\n     * Returns:\n     *     object:\n     *     The resulting attributes for the page.\n     */\n    parse(rsp) {\n        let reviewRequestData;\n\n        if (rsp.reviewRequestData) {\n            reviewRequestData = _.defaults({\n                state: RB.ReviewRequest[rsp.reviewRequestData.state],\n                visibility: RB.ReviewRequest['VISIBILITY_' +\n                                             rsp.reviewRequestData.visibility],\n            }, rsp.reviewRequestData);\n\n            if (reviewRequestData.repository) {\n                reviewRequestData.repository = new RB.Repository(\n                    _.defaults({\n                        localSitePrefix: rsp.reviewRequestData.localSitePrefix,\n                    }, rsp.reviewRequestData.repository));\n            }\n        }\n\n        const reviewRequest = new RB.ReviewRequest(\n            reviewRequestData,\n            {\n                extraDraftAttrs: rsp.extraReviewRequestDraftData,\n            });\n\n        return {\n            reviewRequest: reviewRequest,\n            pendingReview: reviewRequest.createReview(),\n            lastActivityTimestamp: rsp.lastActivityTimestamp,\n            checkForUpdates: rsp.checkForUpdates,\n            checkUpdatesType: rsp.checkUpdatesType,\n        };\n    },\n\n    /**\n     * Register for update notification to the review request from the server.\n     *\n     * The server will be periodically checked for new updates. When a new\n     * update arrives, an update bubble will be displayed in the bottom-right\n     * of the page, and if the user has allowed desktop notifications in their\n     * account settings, a desktop notification will be shown with the update\n     * information.\n     */\n    _registerForUpdates() {\n        this.get('reviewRequest').beginCheckForUpdates(\n            this.get('checkUpdatesType'),\n            this.get('lastActivityTimestamp'));\n    },\n});\n"]}