{"version":3,"sources":["diffFragmentView.es6.js"],"names":[],"mappings":"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","file":"diffFragmentView.js","sourcesContent":["/**\n * A view for managing a loaded diff fragment and its state.\n *\n * This displays a fragment of a diff, offering options for expanding and\n * collapsing content.\n */\nRB.DiffFragmentView = Backbone.View.extend({\n    events: {\n        'click .diff-expand-btn': '_onExpandButtonClicked',\n        'click .diff-collapse-btn': '_onCollapseButtonClicked',\n        'mouseenter': '_tryShowControlsDelayed',\n        'mouseleave': '_tryHideControlsDelayed',\n    },\n\n    /** The exposed headers height to show when collapsed. */\n    COLLAPSED_HEADERS_HEIGHT: 4,\n\n    /** The timeout for a mouseout event to fire after it actually occurs. */\n    _controlsHoverTimeout: 250,\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options that control the view. This must at least provide\n     *         ``loadDiff``.\n     *\n     * Option Args:\n     *     collapsible (bool, optional):\n     *         Whether or not the controls on the view can be collapsed. If\n     *         collapsible, they will also start collapsed. This defaults to\n     *         ``false``.\n     *\n     *     loadDiff (function):\n     *         The function to call to load more of the diff. This must be\n     *         provided by the caller.\n     */\n    initialize(options={}) {\n        this._loadDiff = options.loadDiff;\n        this._collapsible = !!options.collapsible;\n\n        this._$table = null;\n        this._$thead = null;\n        this._$diffHeaders = null;\n        this._$controls = null;\n\n        this._centeredMgr = null;\n        this._contextExpanded = false;\n    },\n\n    /**\n     * Render the view.\n     *\n     * This will start the view off in a collapsed mode.\n     *\n     * Returns:\n     *     RB.DiffFragmentView:\n     *     This instance, for chaining.\n     */\n    render() {\n        /*\n         * Make sure this class isn't on the fragment, in case we're\n         * reloading content.\n         */\n        this.$el.removeClass('allow-transitions');\n\n        this._$table = this.$el.children('table');\n        this._$diffHeaders = this._$table.find('.diff-header');\n        this._$thead = this._$table.children('thead');\n        this._$controls = this._$diffHeaders.find('td > div');\n\n        if (this._collapsible && this.$el.is(':visible')) {\n            this.hideControls();\n        } else {\n            /*\n             * If we're not collapsible, then we're always expanded\n             * by default.\n             */\n            this.showControls();\n        }\n\n        if (this._collapsible) {\n            /*\n             * Once we've hidden the controls, we want to enable transitions for\n             * hovering. We don't apply this before (or make it implicit)\n             * because we don't want all the transitions to take place on page\n             * load, as it's both visually weird and messes with the height\n             * calculation for the collapsed areas.\n             */\n            _.defer(() => this.$el.addClass('allow-transitions'));\n        }\n\n        return this;\n    },\n\n    /**\n     * Show the controls on the specified comment container.\n     */\n    showControls() {\n        /* This will effectively control the opacity of the controls. */\n        this._$table\n            .removeClass('collapsed')\n            .addClass('expanded');\n\n        /*\n         * Undo all the transforms, so that these animate to their normal\n         * positions.\n         */\n        this._$thead.css('transform', '');\n        this._$diffHeaders.css('transform', '');\n    },\n\n    /**\n     * Hide the controls on the specified comment container.\n     *\n     * Args:\n     *     animate (boolean, optional):\n     *         Whether to animate hiding the controls. By default, this is\n     *         ``true``.\n     */\n    hideControls(animate) {\n        /*\n         * Never hide the controls when context has been expanded. It creates\n         * a sort of jarring initial effect.\n         */\n        if (this._contextExpanded) {\n            return;\n        }\n\n        if (animate === false) {\n            this.$el.removeClass('allow-transitions');\n        }\n\n        this._$table\n            .removeClass('expanded')\n            .addClass('collapsed');\n\n        const $firstDiffHeader = this._$diffHeaders.eq(0);\n\n        if ($firstDiffHeader.hasClass('diff-header-above')) {\n            /*\n             * If the first diff header is present, we'll need to transition\n             * the header down to be flush against the collapsed header.\n             */\n            const translateY = $firstDiffHeader.height() -\n                               this.COLLAPSED_HEADERS_HEIGHT;\n\n            this._$thead.css('transform', `translateY(${translateY}px)`);\n        }\n\n        /*\n         * The diff headers won't have the same heights exactly. We need to\n         * compute the proper scale for the correct size per-header.\n         */\n        _.each(this._$diffHeaders, diffHeaderEl => {\n            const $diffHeader = $(diffHeaderEl);\n            const scale = this.COLLAPSED_HEADERS_HEIGHT / $diffHeader.height();\n\n            $diffHeader.css('transform', `scaleY(${scale})`);\n        });\n\n        if (animate === false) {\n            _.defer(() => this.$el.addClass('allow-transitions'));\n        }\n    },\n\n    /*\n     * Common functionality around expand or collapsing the diff fragment.\n     *\n     * This will grab information from the expand/collapse button provided\n     * and load a new diff fragment representing the state described in that\n     * button. The new diff will represent either an expanded or collapsed\n     * state.\n     *\n     * Args:\n     *     $btn (jQuery):\n     *         The button element that triggered the event leading to this\n     *         function call.\n     */\n    _expandOrCollapse($btn) {\n        this._loadDiff({\n            linesOfContext: $btn.data('lines-of-context'),\n            onDone: this._onExpandOrCollapseFinished.bind(this),\n        });\n    },\n\n    /**\n     * Attempt to hide the controls in the given container after a delay.\n     */\n    _tryShowControlsDelayed() {\n        if (this._collapsible) {\n            _.delay(() => {\n                if (this.$el.is(':hover')) {\n                    this.showControls();\n                }\n            }, this._controlsHoverTimeout);\n        }\n    },\n\n    /**\n     * Attempt to hide the controls in the given container after a delay.\n     */\n    _tryHideControlsDelayed() {\n        if (this._collapsible) {\n            _.delay(() => {\n                if (!this.$el.is(':hover')) {\n                    this.hideControls();\n                }\n            }, this._controlsHoverTimeout);\n        }\n    },\n\n    /*\n     * Handler for when an expanded or collapsed fragment has loaded.\n     *\n     * This will reset the state of the view, based on the new fragment, and\n     * re-render the view.\n     */\n    _onExpandOrCollapseFinished() {\n        RB.setActivityIndicator(false, {});\n\n        /* All our HTML has changed, so clean up and re-render everything. */\n        if (this._centeredMgr !== null) {\n            this._centeredMgr.remove();\n            this._centeredMgr = null;\n        }\n\n        const $collapseButtons = this.$('.diff-collapse-btn');\n\n        /*\n         * Check if we have any collapse buttons. If so, we'll need to track\n         * them in a CenteredElementManager.\n         */\n        if ($collapseButtons.length > 0) {\n            this._centeredMgr = new RB.CenteredElementManager({\n                elements: new Map(Array.prototype.map.call(\n                    $collapseButtons,\n                    el => {\n                        const $chunks = $(el)\n                            .closest('.sidebyside')\n                            .children('tbody')\n                            .not('.diff-header');\n\n                        return [el, {\n                            $top: $chunks.eq(0),\n                            $bottom: $chunks.eq(-1),\n                        }];\n                    }))\n            });\n            this._centeredMgr.updatePosition();\n\n            this._contextExpanded = true;\n        } else {\n            this._contextExpanded = false;\n        }\n\n        this.render();\n\n        if (!this._contextExpanded) {\n            this._tryHideControlsDelayed();\n        }\n    },\n\n    /**\n     * Expand a diff fragment.\n     *\n     * When the expand button is clicked, this will trigger loading of a\n     * new diff fragment containing the context as defined by the data\n     * attributes on the button.\n     *\n     * Args:\n     *     e (Event):\n     *         The click event.\n     */\n    _onExpandButtonClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._expandOrCollapse($(e.target).closest('.diff-expand-btn'), e);\n    },\n\n    /**\n     * Collapse an expanded diff fragment.\n     *\n     * When the collapse button is clicked, this will trigger loading of a\n     * new diff fragment containing the context as defined by the data\n     * attributes on the button.\n     *\n     * Args:\n     *     e (Event):\n     *         The click event.\n     */\n    _onCollapseButtonClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._expandOrCollapse($(e.target).closest('.diff-collapse-btn'), e);\n    },\n});\n"]}