{"version":3,"sources":["textBasedReviewableView.es6.js"],"names":[],"mappings":"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","file":"textBasedReviewableView.js","sourcesContent":["/**\n * Base for text-based review UIs.\n *\n * This will display all existing comments on an element by displaying a comment\n * indicator beside it. Users can place a comment by clicking on a line, which\n * will get a light-grey background color upon mouseover, and placing a comment\n * in the comment dialog that is displayed.\n */\nRB.TextBasedReviewableView = RB.FileAttachmentReviewableView.extend({\n    commentBlockView: RB.TextBasedCommentBlockView,\n\n    /**\n     * Initialize the view.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the view.\n     */\n    initialize(options) {\n        RB.FileAttachmentReviewableView.prototype.initialize.call(\n            this, options);\n\n        this._$viewTabs = null;\n        this._$textTable = null;\n        this._$renderedTable = null;\n        this._textSelector = null;\n        this._renderedSelector = null;\n\n        this.on('commentBlockViewAdded', this._placeCommentBlockView, this);\n\n        this.router = new Backbone.Router({\n            routes: {\n                ':viewMode(/line:lineNum)': 'viewMode',\n            },\n        });\n        this.listenTo(this.router, 'route:viewMode', (viewMode, lineNum) => {\n            /*\n             * Router's pattern matching isn't very good. Since we don't\n             * want to stick \"view\" or something before the view mode,\n             * and we want to allow for view, line, or view + line, we need\n             * to check and transform viewMode if it seems to be a line\n             * reference.\n             */\n            if (viewMode.indexOf('line') === 0) {\n                lineNum = viewMode.substr(4);\n                viewMode = null;\n            }\n\n            if (viewMode) {\n                this.model.set('viewMode', viewMode);\n            }\n\n            if (lineNum) {\n                this._scrollToLine(lineNum);\n            }\n        });\n    },\n\n    /**\n     * Remove the reviewable from the DOM.\n     */\n    remove() {\n        _super(this).remove.call(this);\n\n        this._textSelector.remove();\n        this._renderedSelector.remove();\n    },\n\n    /**\n     * Render the view.\n     */\n    renderContent() {\n        this._$viewTabs = this.$('.text-review-ui-views li');\n\n        // Set up the source text table.\n        this._$textTable = this.$('.text-review-ui-text-table');\n\n        this._textSelector = new RB.TextCommentRowSelector({\n            el: this._$textTable,\n            reviewableView: this\n        });\n        this._textSelector.render();\n\n        if (this.model.get('hasRenderedView')) {\n            // Set up the rendered table.\n            this._$renderedTable = this.$('.text-review-ui-rendered-table');\n\n            this._renderedSelector = new RB.TextCommentRowSelector({\n                el: this._$renderedTable,\n                reviewableView: this\n            });\n            this._renderedSelector.render();\n        }\n\n        this.listenTo(this.model, 'change:viewMode', this._onViewChanged);\n\n        const $fileHeader = this.$('.review-ui-header');\n\n        if (this.model.get('numRevisions') > 1) {\n            this._revisionSelectorView = new RB.FileAttachmentRevisionSelectorView({\n                el: $fileHeader.find('#attachment_revision_selector'),\n                model: this.model\n            });\n            this._revisionSelectorView.render();\n            this.listenTo(this._revisionSelectorView, 'revisionSelected',\n                          this._onRevisionSelected);\n\n            this._revisionLabelView = new RB.FileAttachmentRevisionLabelView({\n                el: $fileHeader.find('#revision_label'),\n                model: this.model\n            });\n            this._revisionLabelView.render();\n            this.listenTo(this._revisionLabelView, 'revisionSelected',\n                          this._onRevisionSelected);\n        }\n\n        const reviewURL = this.model.get('reviewRequest').get('reviewURL');\n        const attachmentID = this.model.get('fileAttachmentID');\n        Backbone.history.start({\n            root: `${reviewURL}file/${attachmentID}/`,\n        });\n    },\n\n    /**\n     * Callback for when a new file revision is selected.\n     *\n     * This supports single revisions and diffs. If ``base`` is 0, a\n     * single revision is selected, If not, the diff between ``base`` and\n     * ``tip`` will be shown.\n     *\n     * Args:\n     *     revisions (array of number):\n     *         A 2-element array containing the new revisions to be viewed.\n     */\n    _onRevisionSelected(revisions) {\n        const [base, tip] = revisions;\n\n        // Ignore clicks on No Diff Label.\n        if (tip === 0) {\n            return;\n        }\n\n        const revisionIDs = this.model.get('attachmentRevisionIDs');\n        const revisionTip = revisionIDs[tip - 1];\n\n        /*\n         * Eventually these hard redirects will use a router\n         * (see diffViewerPageView.js for example)\n         * this.router.navigate(base + '-' + tip + '/', {trigger: true});\n         */\n        let redirectURL;\n\n        if (base === 0) {\n            redirectURL = `../${revisionTip}/`;\n        } else {\n            const revisionBase = revisionIDs[base - 1];\n            redirectURL = `../${revisionBase}-${revisionTip}/`;\n        }\n\n        window.location.replace(redirectURL);\n    },\n\n    /**\n     * Scroll the page to the top of the specified line number.\n     *\n     * Args:\n     *     lineNum (number):\n     *         The line number to scroll to.\n     */\n    _scrollToLine(lineNum) {\n        const $table = this._getTableForViewMode(this.model.get('viewMode'));\n        const rows = $table[0].tBodies[0].rows;\n\n        /* Normalize this to a valid row index. */\n        lineNum = RB.MathUtils.clip(lineNum, 1, rows.length) - 1;\n\n        const $row = $($table[0].tBodies[0].rows[lineNum]);\n        $(window).scrollTop($row.offset().top);\n    },\n\n    /**\n     * Return the table element for the given view mode.\n     *\n     * Args:\n     *     viewMode (string):\n     *         The view mode to show.\n     *\n     * Returns:\n     *     jQuery:\n     *     The table element corresponding to the requested view mode.\n     */\n    _getTableForViewMode(viewMode) {\n        if (viewMode === 'source') {\n            return this._$textTable;\n        } else if (viewMode === 'rendered' &&\n                   this.model.get('hasRenderedView')) {\n            return this._$renderedTable;\n        } else {\n            console.assert(false, 'Unexpected viewMode ' + viewMode);\n            return null;\n        }\n    },\n\n    /**\n     * Return the row selector for the given view mode.\n     *\n     * Args:\n     *     viewMode (string):\n     *         The view mode to show.\n     *\n     * Returns:\n     *     RB.TextCommentRowSelector:\n     *     The row selector.\n     */\n    _getRowSelectorForViewMode(viewMode) {\n        if (viewMode === 'source') {\n            return this._textSelector;\n        } else if (viewMode === 'rendered' &&\n                   this.model.get('hasRenderedView')) {\n            return this._renderedSelector;\n        } else {\n            console.assert(false, 'Unexpected viewMode ' + viewMode);\n            return null;\n        }\n    },\n\n    /**\n     * Add the comment view to the line the comment was created on.\n     *\n     * Args:\n     *     commentBlockView (RB.AbstractCommentBlockView):\n     *         The comment view to add.\n     */\n    _placeCommentBlockView(commentBlockView) {\n        const commentBlock = commentBlockView.model;\n        const beginLineNum = commentBlock.get('beginLineNum');\n        const endLineNum = commentBlock.get('endLineNum');\n\n        if (beginLineNum && endLineNum) {\n            const viewMode = commentBlock.get('viewMode');\n            const rowSelector = this._getRowSelectorForViewMode(viewMode);\n\n            if (!rowSelector) {\n                return;\n            }\n\n            let rowEls;\n\n            if (this.model.get('diffRevision')) {\n                /*\n                 * We're showing a diff, so we need to do a search for the\n                 * rows matching the given line numbers.\n                 */\n                rowEls = rowSelector.getRowsForRange(beginLineNum, endLineNum);\n            } else {\n                /*\n                 * Since we know we have the entire content of the text in one\n                 * list, we don't need to use getRowsForRange here, and instead\n                 * can look up the lines directly in the lists of rows.\n                 */\n                const rows = rowSelector.el.tBodies[0].rows;\n\n                /* The line numbers are 1-based, so normalize for the rows. */\n                rowEls = [rows[beginLineNum - 1], rows[endLineNum - 1]];\n            }\n\n            if (rowEls) {\n                commentBlockView.setRows($(rowEls[0]), $(rowEls[1]));\n                commentBlockView.$el.appendTo(\n                    commentBlockView.$beginRow[0].cells[0]);\n            }\n        }\n    },\n\n    /**\n     * Handle a change to the view mode.\n     *\n     * This will set the correct tab to be active and switch which table of\n     * text is shown.\n     */\n    _onViewChanged() {\n        const viewMode = this.model.get('viewMode');\n\n        this._$viewTabs\n            .removeClass('active')\n            .filter(`[data-view-mode=${viewMode}]`)\n                .addClass('active');\n\n        this._$textTable.setVisible(viewMode === 'source');\n        this._$renderedTable.setVisible(viewMode === 'rendered');\n\n        /* Cause all comments to recalculate their sizes. */\n        $(window).triggerHandler('resize');\n    },\n});\n"]}