(function(){(function(a,b,c){var d=b.event,e;d.special.smartresize={setup:function(){b(this).bind("resize",d.special.smartresize.handler)},teardown:function(){b(this).unbind("resize",d.special.smartresize.handler)},handler:function(a,b){var c=this,d=arguments;a.type="smartresize",e&&clearTimeout(e),e=setTimeout(function(){jQuery.event.handle.apply(c,d)},b==="execAsap"?0:100)}},b.fn.smartresize=function(a){return a?this.bind("smartresize",a):this.trigger("smartresize",["execAsap"])},b.Mason=function(a,c){this.element=b(c),this._create(a),this._init()};var f=["position","height"];b.Mason.settings={isResizable:!0,isAnimated:!1,animationOptions:{queue:!1,duration:500},gutterWidth:0,isRTL:!1,isFitWidth:!1},b.Mason.prototype={_filterFindBricks:function(a){var b=this.options.itemSelector;return b?a.filter(b).add(a.find(b)):a},_getBricks:function(a){var b=this._filterFindBricks(a).css({position:"absolute"}).addClass("masonry-brick");return b},_create:function(c){this.options=b.extend(!0,{},b.Mason.settings,c),this.styleQueue=[],this.reloadItems();var d=this.element[0].style;this.originalStyle={};for(var e=0,g=f.length;e<g;e++){var h=f[e];this.originalStyle[h]=d[h]||null}this.element.css({position:"relative"}),this.horizontalDirection=this.options.isRTL?"right":"left",this.offset={};var i=b(document.createElement("div"));this.element.prepend(i),this.offset.y=Math.round(i.position().top),this.options.isRTL?(i.css({float:"right",display:"inline-block"}),this.offset.x=Math.round(this.element.outerWidth()-i.position().left)):this.offset.x=Math.round(i.position().left),i.remove();var j=this;setTimeout(function(){j.element.addClass("masonry")},0),this.options.isResizable&&b(a).bind("smartresize.masonry",function(){j.resize()})},_init:function(a){this._getColumns("masonry"),this._reLayout(a)},option:function(a,c){b.isPlainObject(a)&&(this.options=b.extend(!0,this.options,a))},layout:function(a,c){var d,e,f,g,h,i;for(var j=0,k=a.length;j<k;j++){d=b(a[j]),e=Math.ceil(d.outerWidth(!0)/this.columnWidth),e=Math.min(e,this.cols);if(e===1)this._placeBrick(d,this.colYs);else{f=this.cols+1-e,g=[];for(i=0;i<f;i++)h=this.colYs.slice(i,i+e),g[i]=Math.max.apply(Math,h);this._placeBrick(d,g)}}var l={};l.height=Math.max.apply(Math,this.colYs)-this.offset.y,this.options.isFitWidth&&(l.width=this.cols*this.columnWidth-this.options.gutterWidth),this.styleQueue.push({$el:this.element,style:l});var m=this.isLaidOut?this.options.isAnimated?"animate":"css":"css",n=this.options.animationOptions,o;for(j=0,k=this.styleQueue.length;j<k;j++)o=this.styleQueue[j],o.$el[m](o.style,n);this.styleQueue=[],c&&c.call(a),this.isLaidOut=!0},_getColumns:function(){var a=this.options.isFitWidth?this.element.parent():this.element,b=a.width();this.columnWidth=this.options.columnWidth||this.$bricks.outerWidth(!0)||b,this.columnWidth+=this.options.gutterWidth,this.cols=Math.floor((b+this.options.gutterWidth)/this.columnWidth),this.cols=Math.max(this.cols,1)},_placeBrick:function(a,b){var c=Math.min.apply(Math,b),d=0;for(var e=0,f=b.length;e<f;e++)if(b[e]===c){d=e;break}var g={top:c};g[this.horizontalDirection]=this.columnWidth*d+this.offset.x,this.styleQueue.push({$el:a,style:g});var h=c+a.outerHeight(!0),i=this.cols+1-f;for(e=0;e<i;e++)this.colYs[d+e]=h},resize:function(){var a=this.cols;this._getColumns("masonry"),this.cols!==a&&this._reLayout()},_reLayout:function(a){var b=this.cols;this.colYs=[];while(b--)this.colYs.push(this.offset.y);this.layout(this.$bricks,a)},reloadItems:function(){this.$bricks=this._getBricks(this.element.children())},reload:function(a){this.reloadItems(),this._init(a)},appended:function(a,b,c){if(b){this._filterFindBricks(a).css({top:this.element.height()});var d=this;setTimeout(function(){d._appended(a,c)},1)}else this._appended(a,c)},_appended:function(a,b){var c=this._getBricks(a);this.$bricks=this.$bricks.add(c),this.layout(c,b)},remove:function(a){this.$bricks=this.$bricks.not(a),a.remove()},destroy:function(){this.$bricks.removeClass("masonry-brick").each(function(){this.style.position=null,this.style.top=null,this.style.left=null});var c=this.element[0].style;for(var d=0,e=f.length;d<e;d++){var g=f[d];c[g]=this.originalStyle[g]}this.element.unbind(".masonry").removeClass("masonry").removeData("masonry"),b(a).unbind(".masonry")}},b.fn.imagesLoaded=function(a){var b=this.find("img"),c=[],d=this,e=b.length;if(!b.length){a.call(this);return this}b.one("load error",function(){--e===0&&(e=b.length,b.one("load error",function(){--e===0&&a.call(d)}).each(function(){this.src=c.shift()}))}).each(function(){c.push(this.src),this.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="});return this};var g=function(a){this.console&&console.error(a)};b.fn.masonry=function(a){if(typeof a=="string"){var c=Array.prototype.slice.call(arguments,1);this.each(function(){var d=b.data(this,"masonry");if(!d)g("cannot call methods on masonry prior to initialization; attempted to call method '"+a+"'");else{if(!b.isFunction(d[a])||a.charAt(0)==="_"){g("no such method '"+a+"' for masonry instance");return}d[a].apply(d,c)}})}else this.each(function(){var c=b.data(this,"masonry");c?(c.option(a||{}),c._init()):b.data(this,"masonry",new b.Mason(a,this))});return this}})(window,jQuery);$(window).load(function(){$(".admin-widget").each(function(){var widget=$(this);if(widget.hasClass("widget-hidden")){widget.trigger("widget-hidden")}else{widget.trigger("widget-shown")}})});function postWidgetPositions(widgetType,widgetSize){var positionData={type:widgetType};if(widgetType==="primary"){$("#admin-widgets .widget-"+widgetSize).each(function(i,el){positionData[el.id]=i})}else{$("#admin-extras .widget-"+widgetSize).each(function(i,el){positionData[el.id]=i})}$.ajax({type:"POST",url:"widget-move/",data:positionData})}function postAddedWidgets(widgetType,widgetSize){var selectionData={type:widgetType},widgetCheckbox="#"+widgetSize+"-widget-modal .widget-label input";$(widgetCheckbox).each(function(i,el){if($(el).prop("checked")){selectionData[el.name]="1"}});$.ajax({type:"POST",url:"widget-select/",data:selectionData,success:function(){postWidgetPositions(widgetType,widgetSize);location.reload()}})}function postRemovedWidgets(widgetID,widgetType,widgetSize){var selectionData={type:widgetType};selectionData[widgetID]="0";$.ajax({beforeSend:function(){return confirm(gettext("Are you sure you want to remove this widget?"))},type:"POST",url:"widget-select/",data:selectionData,success:function(){$("#"+widgetID).removeClass("widget-masonry-item").parent().masonry("reload").end().remove();$("#"+widgetSize+"-widget-modal table td").each(function(i,el){var element=$(el);if(element.html()===""){parentID="#all-modal-"+widgetType+"-widgets ";widgetSelectionID="#"+widgetID+"-selection";element.append($(parentID+widgetSelectionID));if(i===0){$("#no-"+widgetSize+"-msg").hide()}return}});postWidgetPositions(widgetType,widgetSize)}})}function makeDashboardSortable(){$("#admin-widgets").sortable({items:".widget-large",revert:true,axis:"y",containment:"parent",stop:function(){postWidgetPositions("primary","large");$("#activity-graph-widget .btn-s").click(function(){$(this).toggleClass("btn-s-checked");getActivityData("same")})}})}function makeSidebarSortable(){$("#admin-extras").sortable({items:".widget-small",revert:true,axis:"y",containment:"parent",start:function(event,ui){ui.item.removeClass("widget-masonry-item");ui.item.parent().masonry("reload")},change:function(event,ui){ui.item.parent().masonry("reload")},stop:function(event,ui){postWidgetPositions("secondary","small");ui.item.addClass("widget-masonry-item");ui.item.parent().masonry({itemSelector:".widget-masonry-item"}).masonry("reload")}})}function createWidgetAdderModals(){var buttonText=gettext("Save Widgets"),buttonsPrimary={},buttonsSecondary={};buttonsPrimary[buttonText]=function(){postAddedWidgets("primary","large");$(this).dialog("close")};$("#large-widget-modal").dialog({height:550,width:315,modal:true,autoOpen:false,resizable:false,buttons:buttonsPrimary});buttonsSecondary[buttonText]=function(){postAddedWidgets("secondary","small");$(this).dialog("close")};$("#small-widget-modal").dialog({height:520,width:335,modal:true,autoOpen:false,resizable:false,buttons:buttonsSecondary})}$(document).ready(function(){var adminExtras=$("#admin-extras"),supportBanner=new RB.SupportBannerView({el:$("#support-banner")}),primary_total,primary_unselected,primary_selected,secondary_total,secondary_unselected,secondary_selected;function refreshWidgets(){var sideWidth=$("#admin-actions").outerWidth(),centerWidth=$("#admin-widgets").outerWidth(),winWidth=$("#dashboard-view").width();adminExtras.width(Math.max(0,winWidth-(sideWidth+centerWidth)-50)).masonry("reload")}adminExtras.masonry({itemSelector:".widget-masonry-item"});$(window).on("reflowWidgets resize",refreshWidgets);refreshWidgets();$("#dashboard-view .widget-heading .expand-collapse").click(function(){var $stateIcon=$(this),$widgetBox=$stateIcon.parents(".admin-widget"),widgetBoxId=$widgetBox.attr("id");$widgetBox.find(".widget-content").slideToggle("fast",function(){var collapsed;adminExtras.masonry("reload");if($widgetBox.hasClass("widget-hidden")){$widgetBox.removeClass("widget-hidden");collapsed=0;$widgetBox.trigger("widget-shown");$stateIcon.removeClass("rb-icon-admin-expand").addClass("rb-icon-admin-collapse")}else{$widgetBox.addClass("widget-hidden");$widgetBox.trigger("widget-hidden");collapsed=1;$stateIcon.removeClass("rb-icon-admin-collapse").addClass("rb-icon-admin-expand")}$.post("widget-toggle/?widget="+widgetBoxId+"&collapse="+collapsed)})});makeDashboardSortable();makeSidebarSortable();$(".widget-draggable").disableSelection().on("hover",function(){$(this).css("cursor","move")});$(".widget-large .rb-icon-remove-widget").on("click",function(){postRemovedWidgets($(this).attr("name"),"primary","large")});$(".widget-small .rb-icon-remove-widget").on("click",function(){postRemovedWidgets($(this).attr("name"),"secondary","small")});createWidgetAdderModals();$("#large-widget-adder a").on("click",function(){$("#large-widget-modal").dialog("open")});$("#small-widget-adder a").on("click",function(){$("#small-widget-modal").dialog("open")});primary_total=$("#all-modal-primary-widgets img").length;primary_unselected=$("#large-widget-modal td").length;primary_selected=primary_total-primary_unselected;while(primary_selected>0){$("#large-widget-modal table").append("<tr><td></td></tr>");primary_selected-=1}if(primary_unselected>0){$("#no-large-msg").hide()}secondary_total=$("#all-modal-secondary-widgets img").length;secondary_unselected=$("#small-widget-modal td").length;secondary_selected=secondary_total-secondary_unselected;while(secondary_selected>0){if(secondary_selected%2===1){$("#small-widget-modal table tr").last().append("<td></td>");secondary_selected-=1}else{$("#small-widget-modal table").append("<tr><td></td><td></td></tr>");secondary_selected-=2}}if(secondary_unselected>0){$("#no-small-msg").hide()}supportBanner.render()});RB.SupportBannerView=Backbone.View.extend({_loadingHTML:_.template(["<h2><%- titleText %></h2>",'<p><span class="fa fa-spin fa-spinner"></span></p>'].join(""))({titleText:gettext("Retrieving support information...")}),_errorHTML:_.template(["<h2><%- titleText %></h2>","<p><%- bodyText %></p>","<p><%= fileText %></p>"].join(""))({titleText:gettext("Failed to retrieve support information"),bodyText:gettext("We could not communicate with the Beanbag, Inc. server to retrieve your support information. You may be behind a firewall or have no Internet access."),fileText:gettext('You may file an issue on our <a href="https://reviewboard.googlegroups.com">community support tracker.</a>')}),initialize:function(){var now=new Date;console.assert(RB.SupportBannerView.instance===null);RB.SupportBannerView.instance=this;_.bindAll(this,"_onError");window.addEventListener("error",this._onError,true);this._script=$("<script />").attr("src",RB.SupportBannerView.supportURL+"?"+$.param({"support-data":SUPPORT_DATA,callback:"RB.SupportBannerView.instance.receive",_:now.valueOf()})).get(0);document.body.appendChild(this._script)},_onError:function(e){if(e.target===this._script){this.render({html:this._errorHTML,className:"error"});window.removeEventListener("error",this._onError,true)}},render:function(options){options=_.extend({className:"loading",html:this._loadingHTML},options);this.$el.empty().html(options.html).attr("class",options.className);return this},receive:function(options){window.removeEventListener("error",this._onError,true);this.render({className:options.supportLevel+"-support",html:options.html})}},{instance:null,supportURL:"https://www.beanbaginc.com/support/reviewboard/_status/"})}).call(this);
