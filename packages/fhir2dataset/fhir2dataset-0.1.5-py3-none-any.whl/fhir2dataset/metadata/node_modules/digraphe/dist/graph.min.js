!function(e,t){if("function"==typeof define&&define.amd)define(["lodash","event-emitter"],t);else if("undefined"!=typeof module&&module.exports){var i=require("events").EventEmitter;module.exports=t(require("lodash"),i)}else{var n=this,o=t(n._,n.EventEmitter2),r=n[e];o.noConflict=function(){return n[e]=r,o},n[e]=o}}("Graph",function(u,e){var f=function(){e.apply(this),this.nodes={},this.edges=[]};f.prototype=new e,f.Visitor={},f.prototype.addNode=function(e,t){var i=new f.Node(e,t);return this.hasNode(i)||(this.nodes[i.id]=i,this.emit("node.added",this.nodes[i.id])),this.nodes[i.id]},f.prototype.addEdge=function(e,t,i){e=this.addNode(e),t=this.addNode(t);var n=new f.Edge(e,t,i);if(!this.hasEdge(n))return e.addEdge(n),t.addEdge(n),this.edges.push(n),this.emit("edge.added",n),n},f.Visitor.DFS=function(e,t,i){var n={},o=e.nodes[t instanceof f.Node?t.id:t];if(!o)throw new Error("The given source node is not part of this graph");var r=function(e){n[e.id]=!0,u.each(e.adjacents(),function(e){n[e.id]||(i&&i(e),r(e))})};r(o)},f.Visitor.BFS=function(e,t,i){var n=[],o={},r=0,s=e.nodes[t instanceof f.Node?t.id:t];if(!s)throw new Error("The given source node is not part of this graph");var d=[s];for(n.push(d),i&&i(d,r),o[s.id]=!0;0<n.length;){var h=n.shift(),a=[];u.each(h,function(e){u.each(e.adjacents(),function(e){o[e.id]||(a.push(e),o[e.id]=!0)}),n.push(a)}),a.length&&i&&i(a,++r)}},f.Visitor.Stacked=function(e,t,o){var r=[],s=0,i=e.nodes[t];if(!i)throw new Error("The given node is not part of this graph");r.push(i);var d=function(e){for(var t=0;t<e.edges.length;++t)if(e.edges[t].target.id!==e.id){var i=e.edges[t],n=i.target;if(u.find(r,{id:n.id}))continue;r.push(n),s+=i.weight,o&&o(n,r,s),d(n),s-=i.weight,r.pop()}};d(i)},f.prototype.forEach=function(e,t){f.Visitor.DFS(this,e,t)};return f.prototype.routes=function(n){var e,t,o,r,s=[];if(!n||!n.from)throw new Error("At least a source node is expected");return n.to?(this.hasNode(n.from)&&this.hasNode(n.to)&&f.Visitor.Stacked(this,n.from,function(e,t,i){if(e.id===n.to){if(n.where&&n.where.length!==t.length)return;s.push(new f.Route(t.slice(),i))}}),s):(e=this,t=n.from,o=n.where,r=[],f.Visitor.Stacked(e,t,function(e,t,i){o&&o.length!==t.length||r.push(new f.Route(t.slice(),i))}),r)},f.prototype.findRoute=function(t){var i,e=this.routes({from:t[0],where:{length:t.length}});if(e)return u.each(e,function(e){if(u.map(e.path,"id").toString()===t.toString())return i=e,!1}),i},f.prototype.hasRoute=function(o){var e=this.nodes[o.head().id];if(!this.hasNode(e))return!1;var r=function(e,t){var i,n=!1;return u.each(e.adjacents(),function(e){if(e.equals(o.path[t]))return i=e,!(n=!0)}),!!n&&(t===o.path.length-1||r(i,++t))};return r(e,1)},f.prototype.removeNode=function(n){this.nodes[n]&&(u.each(this.edges,function(e){if(e){var t=e.source.id,i=e.target.id;t!==n&&i!==n||this.removeEdge(t,i)}}.bind(this)),delete this.nodes[n],this.emit("node.removed",n))},f.prototype.removeEdge=function(e,t){var i=this.nodes[e],n=this.nodes[t];this.hasNode(i)&&this.hasNode(n)&&this.hasEdge(i,n)&&(this.edges=u.reject(this.edges,function(e){return e.target.id===n.id&&e.source.id===i.id}),u.each(this.nodes,function(e){e.edges=u.reject(e.edges,function(e){return e.target.id===n.id&&e.source.id===i.id})}),this.emit("edge.removed",e,t))},f.prototype.hasEdge=function(e,t,i){var n=function(t){return!u.isUndefined(u.find(this.edges,function(e){return e.equals(t)}))}.bind(this);if(e instanceof f.Edge)return n(e);var o=e instanceof f.Node?e:this.nodes[e],r=t instanceof f.Node?t:this.nodes[t];return!(!o||!r)&&n(new f.Edge(o,r,i))},f.prototype.hasNode=function(e){return e instanceof f.Node?void 0!==this.nodes[e.id]:void 0!==this.nodes[e]},f.prototype.clear=function(){for(;0<this.edges.length;)this.removeEdge(this.edges[0].source.id,this.edges[0].target.id);for(var e in this.nodes)this.removeNode(e)},(f.Node=function(e,t){if("string"!=typeof e)throw new Error("A node id was required");this.id=e,this.object=t||{},this.edges=[]}).prototype.parents=function(){var t=[];return u.each(this.edges,function(e){e.target.id===this.id&&t.push(e.source)}.bind(this)),t},f.Node.prototype.children=function(){var t=[];return u.each(this.edges,function(e){e.source.id===this.id&&t.push(e.target)}.bind(this)),t},f.Node.prototype.adjacents=function(){var t=[];return u.each(this.edges,function(e){e.target.id!==this.id&&t.push(e.target)}.bind(this)),t},f.Node.prototype.addEdge=function(e){if(!(e instanceof f.Edge))throw new Error("An edge was expected");this.hasEdge(e)||this.edges.push(e)},f.Node.prototype.hasEdge=function(e){if(!(e instanceof f.Edge))return!1;for(var t=0;t<this.edges.length;++t)if(this.edges[t].equals(e))return!0;return!1},f.Node.prototype.equals=function(e){return e instanceof f.Node&&e.id===this.id},(f.Edge=function(e,t,i){if(!(e instanceof f.Node&&t instanceof f.Node))throw new Error("A source node and a source target were required");this.source=e,this.target=t,this.options=i||{},this.weight=this.options.weight||0}).prototype.equals=function(e){return e instanceof f.Edge&&(e.source.id===this.source.id&&e.target.id===this.target.id)},f.Route=function(e,t){if(!e||!e.length||"number"!=typeof t)throw new Error("A non empty path as well as a weight were expected");this.path=e,this.weight=t,this.head=function(){return this.path[0]},this.tail=function(){return this.path[this.path.length-1]},this.length=function(){return this.path.length}},f});