(()=>{function G(t){let e={};return t.split(";").forEach(r=>{let[o,s]=r.split("=");e[o]=s}),e}var i={username:sessionStorage.getItem("username"),userId:sessionStorage.getItem("userId"),token:G(document.cookie).token||null,isLoggedIn:()=>i.username!==null&&i.userId!==null,init:()=>i.isLoggedIn()?(console.log("Already logged in"),Promise.resolve()):i.token===null?(console.log("No saved token found"),Promise.resolve()):m.request({method:"GET",url:"/api/verify-token"}).then(t=>{sessionStorage.setItem("username",t.username),sessionStorage.setItem("userId",t.user_id),i.username=t.username,i.userId=t.user_id}).catch(t=>{t.code==401&&i.clearCredentials()}).finally(m.redraw),saveLoginResults:({userId:t,username:e,token:r,remember:o})=>{sessionStorage.setItem("userId",t),sessionStorage.setItem("username",e),i.userId=t,i.username=e,i.token=r},logout:()=>i.request({method:"POST",url:"/api/logout"}).then(i.clearCredentials).catch(t=>{t.code==401?i.clearCredentials():console.log(t)}),clearCredentials:()=>{i.username=null,i.token=null,i.userId=null,sessionStorage.clear()},request:t=>m.request(t).catch(e=>{throw e.code==401?i.clearCredentials():e.code==500&&alert(e.response.message),e})},d={query:"",result:{},cache:{},isLoading:!0,performSearch:t=>{d.query=t,d.cache[t]?d.result=d.cache[t]:(d.isLoading=!0,m.redraw(),m.request({method:"GET",url:"/api/search/:query",params:{query:t}}).then(e=>{d.cache[t]=e,d.result=e}).catch(e=>{console.log("TODO",e)}).finally(()=>{d.isLoading=!1}))}},k={cache:{},cacheGet:(t,e,r)=>{let o=[t,e,r].join(",");return k.cache[o]||null},cacheSet:(t,e,r,o)=>{let s=[t,e,r].join(",");k.cache[s]=o},get:({site:t,titleId:e,chapterId:r})=>{let o=k.cacheGet(t,e,r);return o?Promise.resolve(o):i.request({method:"GET",url:"/api/chapter/:site/:titleId/:chapterId",params:{site:t,titleId:e,chapterId:r}}).then(s=>(k.cacheSet(t,e,r,s),s))}};var b={view:t=>m("h2.blink",[m("i.icon.icon-loader.spin")," loading..."])},g={view:t=>m("button",Object.assign({class:t.attrs.color||""},t.attrs),[t.attrs.icon?m(`i.icon.icon-${t.attrs.icon}`):null,t.attrs.text?m("span",t.attrs.text):null])},j={view:t=>m("div.utils--chapter",[m(m.route.Link,{href:`/m/${t.attrs.site}/${t.attrs.titleId}/${t.attrs.chapter.id}`,class:"touch-friendly"},[t.attrs.chapter.is_read?m("i.icon.icon-check-square.utils--chapter--read-icon"):null,m("span",q(t.attrs.chapter)),t.attrs.chapter.groups.map(e=>m("span.utils--chapter--group",C(e,20)))])])};function C(t,e){return t.length>e?`${t.substring(0,e)}...`:t}function q(t){let e="";return typeof t.num_major!="undefined"&&(e+=(t.volume?"Ch.":"Chapter ")+t.num_major),t.num_minor&&(e+="."+t.num_minor),t.volume&&(e+=" Vol. "+t.volume),t.name&&(e+=" - "+t.name),e}function B(t){let e=!1;return{view:r=>{let o;return i.isLoggedIn()?o=m("span.nav--greeting",[m("span",["Welcome, ",m("b",i.username)]),m(g,{text:e?" logging out":" logout",icon:"log-out",color:"red",title:"Log out",onclick:s=>{e=!0,m.redraw(),i.logout().then(()=>{m.route.set("/")}).finally(()=>{e=!1})},disabled:e?"disabled":null})]):o=m(m.route.Link,{class:"nav--link",href:"/a"},[m("i.icon.icon-log-in"),"login / register"]),m("nav",[m(m.route.Link,{class:"nav--logo",href:i.isLoggedIn()?"/f":"/"},[m("img.nav--logo--favicon",{src:"/static/favicon.svg",alt:"home"}),m("img.nav--logo--img",{src:"/static/pytaku.svg",alt:"home"})]),m("form.nav--search-form",{onsubmit:s=>{s.preventDefault(),m.route.set("/s/:query",{query:d.query})}},[m("input[placeholder=search manga title]",{onchange:s=>{d.query=s.target.value},value:d.query}),m(g,{color:"red",icon:"search",type:"submit"})]),o])}}}var R={view:t=>[m(B),t.children]},I=R;function F(t){let e,r,o=!1,s,p,h,u,l,v,y=!1,w=!1;return{oncreate:c=>{document.title="Authentication - Pytaku"},view:c=>m("div.content.auth",[m("form.auth--form",{onsubmit:a=>{a.preventDefault(),s="",w=!0,m.redraw(),m.request({method:"POST",url:"/api/login",body:{username:e,password:r,remember:o}}).then(n=>{let x=n.user_id,S=n.token,_=e;i.saveLoginResults({userId:x,username:_,token:S,remember:o}),m.route.set("/f")}).catch(n=>{s=n.response.message}).finally(()=>{w=!1})}},[m("h1","Login"),m("input[placeholder=username][name=username][required]",{value:e,oninput:a=>{e=a.target.value}}),m("input[placeholder=password][name=password][type=password][required]",{value:r,oninput:a=>{r=a.target.value}}),m("label[for=auth--remember].auth--checkbox-label",[m("input[type=checkbox][name=remember][id=auth--remember]",{checked:o,onchange:a=>{o=a.target.checked}})," Remember me"]),m(g,{type:"submit",disabled:w?"disabled":null,text:w?" Logging in...":" Log in",icon:"log-in",color:"blue"}),m("p.auth--form--error-message",s)]),m("form.auth--form",{onsubmit:a=>{if(a.preventDefault(),l="",m.redraw(),h!==u){l="Password confirmation didn't match!",v=!1;return}y=!0,m.redraw(),m.request({method:"POST",url:"/api/register",body:{username:p,password:h}}).then(n=>{v=!0,l=n.message,e=p,r=h}).catch(n=>{l=n.response.message,v=!1}).finally(()=>{y=!1})}},[m("h1","Register"),m("input[placeholder=username][name=username][required]",{value:p,oninput:a=>{p=a.target.value}}),m("input[placeholder=password][name=password][type=password][required]",{value:h,oninput:a=>{h=a.target.value}}),m("input[placeholder=confirm password][name=confirm][type=password][required]",{value:u,oninput:a=>{u=a.target.value}}),m(g,{type:"submit",disabled:y?"disabled":null,text:y?" Registering...":" Register",icon:"user-plus",color:"green"}),m("p",{class:"auth--form--message-"+(v?"success":"error")},l)])])}}var P=F;var V={oncreate:t=>{document.title="Pytaku"},view:t=>m("div.content",[m("p","Try searching for some manga title using the box above."),m("p","Logging in allows you to follow manga titles.")])},$=V;var U={view:t=>{let e=t.attrs.title,r=3;return m("div.follows--title"+(e.chapters.length===0?".empty":".non-empty"),[m("div",[m(m.route.Link,{href:`/m/${e.site}/${e.id}`,title:`${e.name} - ${e.site}`},[m("img.follows--cover",{src:e.thumbnail,alt:e.name})])]),m("div.follows--chapters",[e.chapters.length>r?m(m.route.Link,{href:`/m/${e.site}/${e.id}`,class:"follows--chapter follows--more"},`and ${e.chapters.length-r} more...`):"",e.chapters.slice(-r).map(o=>m(j,{site:e.site,titleId:e.id,chapter:o}))])])}};function H(t){let e=[],r=!1;return{oninit:()=>{r=!0,i.request({method:"GET",url:"/api/follows"}).then(o=>{e=o.titles}).catch(o=>{console.log(o)}).finally(()=>{r=!1})},oncreate:o=>{document.title="Stuff I follow - Pytaku"},view:o=>{let s="";return r?m("div.content",m(b)):e.length===0?m("div.content",[m("p","You're not following any title yet. Try searching for some."),m("p",["Migrating from Tachiyomi? ",m(m.route.Link,{href:"/i"},"Use the importer"),"!"])]):m("div.follows.content",[e.map(p=>m(U,{title:p}))])}}}var T=H;var W={oninit:t=>{document.title=`"${t.attrs.query}" search results`,d.performSearch(t.attrs.query)},view:t=>m("div.content",d.isLoading?m(b):Object.entries(d.result).map(([e,r])=>m("div",[m("h1.search--site-heading",e),r?m("p.search--result-text",["Showing ",m("strong",r.length),` result${r.length>1?"s":""} for `,d.query]):m("p.search--result-text",`No results for "${d.query}"`),m("div.search--results",r.map(o=>m(m.route.Link,{class:"search--result",href:`/m/${e}/${o.id}`,title:o.name},[m("img",{src:o.thumbnail,alt:o.name}),m("span",C(o.name,50))])))])))},A=W;function Y(t){let e=!1,r=!1,o=!1,s={},p;return{oninit:h=>{document.title="Manga",e=!0,m.redraw(),i.request({method:"GET",url:"/api/title/:site/:titleId",params:{site:h.attrs.site,titleId:h.attrs.titleId}}).then(u=>{s=u,document.title=s.name}).finally(()=>{e=!1})},view:h=>{if(!e&&i.isLoggedIn()){p=!0;for(let u of s.chapters)if(!u.is_read){p=!1;break}}return m("div.content",e?m(b):[m("h1",s.name),m("div.title--details",[i.isLoggedIn()?[m(g,{icon:"bookmark",disabled:r?"disabled":null,text:r?"submitting...":s.is_following?"following":"follow",color:s.is_following?"red":"green",title:s.is_following?"Click to unfollow":"Click to follow",onclick:u=>{r=!0,m.redraw(),i.request({method:"POST",url:"/api/follow",body:{site:s.site,title_id:s.id,follow:!s.is_following}}).then(l=>{s.is_following=l.follow}).finally(()=>{r=!1})}}),m(g,{icon:"check-square",disabled:o||p?"disabled":null,text:o?"submitting...":p?"all read!":"read all",color:"green",title:p?null:"Click to mark all chapters as read",onclick:u=>{o=!0,m.redraw(),i.request({method:"POST",url:"/api/read",body:{read:s.chapters.filter(l=>!l.is_read).map(l=>({site:s.site,title_id:s.id,chapter_id:l.id}))}}).then(l=>{s.chapters.forEach(v=>{v.is_read=!0})}).finally(()=>{o=!1})}})]:null,m("a.touch-friendly[title=Go to source site][target=_blank]",{href:s.source_url},[s.site,m("i.icon.icon-arrow-up-right")])]),m("img.title--cover[alt=cover]",{src:s.cover}),s.descriptions.map(u=>m("p",u)),s.chapters?s.chapters.map(u=>m(j,{site:s.site,titleId:s.id,chapter:u})):m("p","This one has no chapters.")])}}}var E=Y;var J={view:()=>m("h2",[m("i.icon.icon-loader.spin")])},K={view:()=>m("h2",[m("i.icon.icon-loader")])},Q={view:t=>m(g,{text:"Errored. Try again?",color:"red",onclick:e=>{let{page:r}=t.attrs;r.status=L.LOADING,r.src=r.src.endsWith("?")?r.src.slice(0,-1):r.src+"?"}})},L={LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"};function D(t){let e;return{oninit:r=>{e=r.attrs.src},view:r=>m("img",{src:e,style:r.attrs.style,onload:r.attrs.onload,onerror:o=>{e===r.attrs.src&&r.attrs.altsrc!==null?e=r.attrs.altsrc:r.attrs.onerror(o)}})}}function X(t){let e=!1,r={},o=[],s=[],p,h,u=null,l=null,v=[];function y(){if(s.length>0){let[c,a]=s.splice(0,1)[0];o.push({status:L.LOADING,src:c,altsrc:a})}else r.next_chapter&&u===null&&(u=k.get({site:p,titleId:h,chapterId:r.next_chapter.id}).then(c=>{console.log("Preloading next chapter:",q(c)),c.pages_alt.length>0?l=c.pages.map((a,n)=>[a,c.pages_alt[n]]):l=c.pages.map(a=>[a,null]),w(),w()}))}function w(){if(l!==null&&l.length>0){let[c,a]=l.splice(0,1)[0];v.push({src:c,altsrc:a})}}return{oninit:c=>{document.title="Manga chapter",p=c.attrs.site,h=c.attrs.titleId,e=!0,m.redraw(),k.get({site:c.attrs.site,titleId:c.attrs.titleId,chapterId:c.attrs.chapterId}).then(a=>{r=a,document.title=q(r),r.pages_alt.length>0?s=r.pages.map((n,x)=>[n,r.pages_alt[x]]):s=r.pages.map(n=>[n,null]),y(),y(),y()}).finally(()=>{e=!1})},view:c=>{if(e)return m("div.chapter.content",m(b));let{site:a,titleId:n}=c.attrs,x=r.prev_chapter,S=r.next_chapter,_=m("div.chapter--buttons",[x?m(m.route.Link,{class:"touch-friendly",href:`/m/${a}/${n}/${x.id}`},[m("i.icon.icon-chevrons-left"),m("span","prev")]):m(g,{text:"prev",icon:"chevrons-left",disabled:!0}),m(m.route.Link,{class:"touch-friendly",href:`/m/${a}/${n}`},[m("i.icon.icon-list"),m("span"," chapter list")]),m(m.route.Link,{class:"touch-friendly",href:S?`/m/${a}/${n}/${S.id}`:`/m/${a}/${n}`,onclick:f=>(i.isLoggedIn()&&i.request({method:"POST",url:"/api/read",body:{read:[{site:a,title_id:n,chapter_id:r.id}]}}),!0)},[m("span",S?"next":"finish"),m("i.icon.icon-"+(S?"chevrons-right":"check-circle"))])]);return m("div.chapter.content",[m("h1",q(r)),_,m("div",{class:"chapter--pages"+(r.is_webtoon?" chapter--webtoon":"")},[o.map((f,z)=>m("div",{key:f.src},[m(D,{src:f.src,altsrc:f.altsrc,style:{display:f.status===L.SUCCEEDED?"block":"none"},onload:O=>{f.status=L.SUCCEEDED,y()},onerror:O=>{f.status=L.FAILED,y()}}),f.status===L.LOADING?m(J):null,f.status===L.FAILED?m("div",{style:{"margin-bottom":".5rem"}},m(Q,{page:f})):null])),s.map(()=>m(K))]),_,v.map(f=>m(D,{style:{display:"none"},onload:w,onerror:w,src:f.src,altsrc:f.altsrc}))])}}}var N=X;function Z(t){let e=null,r=null,o=!1;return{oninit:s=>{document.title="Import from Tachiyomi"},view:s=>m("div.content",[m("h1","Importing from Tachiyomi"),m("form[enctype=multipart/form-data]",{onsubmit:p=>{p.preventDefault();let h=document.getElementById("tachiyomi").files[0],u=new FormData;u.append("tachiyomi",h),o=!0,e=null,m.redraw(),i.request({method:"POST",url:"/api/import",body:u}).then(l=>{e=l.message,r=!0}).catch(l=>{e=l.response.message,r=!1}).finally(()=>{o=!1})}},[m("p",["Go to ",m("b","Settings > Backup > Create backup"),", then upload the generated json file here:"]),m("input[type=file][id=tachiyomi].importer--filepicker"),m("br"),m(g,{type:"submit",text:o?"uploading...":"upload",color:"green",icon:"upload",disabled:o?"disabled":null})]),m("p",{class:`importer--${r?"success":"failure"}`},e),r?m(m.route.Link,{href:"/f"},"See your following list here."):null])}}var M=Z;i.init().then(()=>{let t=document.getElementById("spa-root");m.route.prefix="",m.route(t,"/",{"/":{onmatch:()=>{if(i.isLoggedIn())m.route.set("/f",null,{replace:!0});else return $},render:e=>m(I,e)},"/a":{onmatch:()=>{if(i.isLoggedIn())m.route.set("/f",null,{replace:!0});else return P},render:e=>m(I,e)},"/f":{onmatch:()=>{if(i.isLoggedIn())return T;m.route.set("/a",null,{replace:!0})},render:e=>m(I,e)},"/s/:query":{render:e=>m(I,m(A,{query:e.attrs.query,key:e.attrs.query}))},"/m/:site/:titleId":{render:e=>m(I,m(E,{site:e.attrs.site,titleId:e.attrs.titleId}))},"/m/:site/:titleId/:chapterId":{render:e=>m(I,m(N,{site:e.attrs.site,titleId:e.attrs.titleId,chapterId:e.attrs.chapterId,key:e.attrs.chapterId}))},"/i":{onmatch:()=>{if(i.isLoggedIn())return M;m.route.set("/a",null,{replace:!0})},render:e=>m(I,e)}})});})();
//# sourceMappingURL=main.min.js.map
